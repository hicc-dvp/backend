package hicc.club_fair_2025.controller;

import org.springframework.http.*;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.client.RestTemplate;

import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;

/**
 * ë„¤ì´ë²„ ì§€ë„ ê²€ìƒ‰ ìš”ì²­ì„ í”„ë¡ì‹œí•˜ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬
 * - ë„¤ì´ë²„ ì§€ë„ ê²€ìƒ‰ URLì„ í˜¸ì¶œí•˜ì—¬ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì§ì ‘ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì§€ì›
 */
@RestController
@RequestMapping("/naver")
public class ProxyController {

    private final RestTemplate restTemplate;

    /**
     * ê¸°ë³¸ ìƒì„±ì - RestTemplate ê°ì²´ ì´ˆê¸°í™”
     */
    public ProxyController() {
        this.restTemplate = new RestTemplate();
    }

    /**
     * ë„¤ì´ë²„ ì§€ë„ ê²€ìƒ‰ í”„ë¡ì‹œ API
     *
     * @param name ê²€ìƒ‰í•  ì¥ì†Œëª… (í•œê¸€ ì§€ì›)
     * @return ë„¤ì´ë²„ ì§€ë„ ê²€ìƒ‰ ê²°ê³¼
     */
    @GetMapping("/map")
    public ResponseEntity<String> getNaverMap(
            @RequestParam(name = "name", required = false, defaultValue = "ì„œìš¸ì—­") String name) {

        // ğŸ”¹ URL ì¸ì½”ë”© (í•œê¸€, ê³µë°± ë“± ì²˜ë¦¬)
        String encodedName = URLEncoder.encode(name, StandardCharsets.UTF_8);

        // ğŸ”¹ ë„¤ì´ë²„ ì§€ë„ ê²€ìƒ‰ URL
        String url = "https://map.naver.com/v5/search/" + encodedName;

        // ğŸ”¹ ë„¤ì´ë²„ API ìš”ì²­ì„ ìœ„í•œ HTTP í—¤ë” ì„¤ì •
        HttpHeaders headers = new HttpHeaders();
        headers.set("User-Agent", "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36");
        headers.set("Referer", "https://map.naver.com"); // ë„¤ì´ë²„ ì§€ë„ì—ì„œ ìš”ì²­í•œ ê²ƒì²˜ëŸ¼ ë³´ì´ê²Œ ì„¤ì •
        headers.set("Accept", "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8");
        headers.set("Accept-Language", "ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7");

        HttpEntity<String> entity = new HttpEntity<>(headers);

        try {
            // ğŸ”¹ ë„¤ì´ë²„ ì§€ë„ API í˜¸ì¶œ
            ResponseEntity<String> response = restTemplate.exchange(
                    url,
                    HttpMethod.GET,
                    entity,
                    String.class
            );

            // ğŸ”¹ ì‘ë‹µ í—¤ë” ì„¤ì • (iframe ì‚¬ìš© í—ˆìš©)
            HttpHeaders responseHeaders = new HttpHeaders();
            responseHeaders.add("X-Frame-Options", "ALLOW-FROM https://hicc.space");
            responseHeaders.add("Content-Security-Policy", "frame-ancestors 'self' https://hicc.space");

            // ğŸ”¹ ë„¤ì´ë²„ ì‘ë‹µì„ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ë‹¬
            return ResponseEntity
                    .status(response.getStatusCode())
                    .headers(responseHeaders)
                    .body(response.getBody());

        } catch (Exception e) {
            // ğŸ”¹ API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ ë°˜í™˜
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body("ë„¤ì´ë²„ ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    }
}
