package hicc.club_fair_2025.controller;

import org.springframework.http.*;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.client.RestTemplate;

import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;

@RestController
@RequestMapping("/naver")
public class ProxyController {

    private final RestTemplate restTemplate;

    public ProxyController() {
        this.restTemplate = new RestTemplate();
    }

    @GetMapping("/map")
    public ResponseEntity<String> getNaverMap(
            @RequestParam(name = "name", required = false, defaultValue = "서울역") String name) {

        // URL 인코딩
        String encodedName = URLEncoder.encode(name, StandardCharsets.UTF_8);
        String url = "https://map.naver.com/v5/search/" + encodedName;

        HttpHeaders headers = new HttpHeaders();
        headers.set("User-Agent", "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36");
        headers.set("Referer", "https://map.naver.com");
        headers.set("Accept", "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8");
        headers.set("Accept-Language", "ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7");

        HttpEntity<String> entity = new HttpEntity<>(headers);

        try {
            ResponseEntity<String> response = restTemplate.exchange(
                    url,
                    HttpMethod.GET,
                    entity,
                    String.class
            );

            // 응답 헤더 설정
            HttpHeaders responseHeaders = new HttpHeaders();
            responseHeaders.add("X-Frame-Options", "ALLOW-FROM https://hicc.space");
            responseHeaders.add("Content-Security-Policy", "frame-ancestors 'self' https://hicc.space");

            return ResponseEntity
                    .status(response.getStatusCode())
                    .headers(responseHeaders)
                    .body(response.getBody());

        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body("네이버 지도를 불러오는데 실패했습니다.");
        }
    }
}
